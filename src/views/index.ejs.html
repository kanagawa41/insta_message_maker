<!DOCTYPE HTML>
<!--
  Spectral by HTML5 UP
  html5up.net | @ajlkn
  Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
  <head>
    <title>トップ | <%= title.jp %></title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="../assets/css/main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
  </head>
  <body class="is-preload">

    <!-- Page Wrapper -->
      <div id="page-wrapper">

        <!-- Header -->
          <%- include('layout/header.ejs.html') -%>

        <!-- Main -->
          <article id="main">
            <section class="wrapper style5">
              <div class="inner">

                <section>
                  <div class="row">
                    <div class="col-12" style="padding-bottom: 2em;">
                      <div class="row gtr-uniform">
                        <div class="col-12">
                          <h4 style="color: #21b2a6">メッセージ<sub>##MSG##</sub></h4>
                          <textarea name="msg" id="msg" placeholder="メッセージを入力" rows="3"></textarea>
                        </div>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="col-12">
												<ul class="icons">
													<li id="option-open-btn"><a href="#" class="icon fa-arrow-circle-down" click="return false;"></a><b style="padding-left: 0.5em;">オプションを開く</b></li>
													<li id="option-close-btn" style="display: none;"><a href="#" class="icon fa-arrow-circle-up" click="return false;"></a><b style="padding-left: 0.5em;">オプションを閉じる</b></li>
												</ul>
                      </div>
                    </div>
                    <div id="option-area" style="display: none; padding-bottom: 2em;" class="col-12">
                      <div class="row gtr-uniform">
                        <div class="col-12">
                          <h4 style="color: #21b2a6">テンプレート</h4>
                          <textarea name="template-msg" id="template-msg" placeholder="特殊記号などを含めたテンプレートを記入してください。" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                          <h4 style="color: #21b2a6">タグ<sub>##TAGS##</sub></h4>
                          <input id="tags" name="tags" placeholder="シャープ(#)か空白区切りでタグを入力" type="text">

                          <sub>または選ぶ</sub>
                          <!-- TODO: 仮設置 -->
                          <select id="tag-list" name="tag-list" >
                          </select>

                          <input type="checkbox" name="random-order" id="random-order">
                          <label for="random-order">順番をランダム</label>
                          <input type="checkbox" name="tag-per-line" id="tag-per-line">
                          <label for="tag-per-line">改行して表示</label>

	                        <div class="row">
	                          <div class="col-4">
	                            <input id="select-tag-num" name="select-tag-num" placeholder="個数" type="text">
	                          </div>
	                          <div class="col-3">
	                            <sub>個を選択</sub>
	                          </div>
	                        </div>
                        </div>
                        <div class="col-12">
                          <h4 style="color: #21b2a6">空白改行の代わり<sub></sub></h4>
                          <input id="new-line" name="new-line" placeholder="例:「・」「.」「　(大文字空白)」などを入力" type="text">
                        </div>
                      </div>
                    </div>
                    <div class="col-12" style="padding-bottom: 2em;">
                      <ul class="actions fit">
                        <li><a href="#" id="make-btn" class="make-btn button primary fit" onclick="return false;">作成</a></li>
                      </ul>
                      <textarea name="make-msg" id="make-msg" placeholder="作成されたメッセージ" onclick="this.select();" rows="5"></textarea>
                    </div>
                  </div>
                </section>
              </div>
            </section>
          </article>

        <!-- Footer -->
          <%- include('layout/footer.ejs.html') -%>

      </div>

    <!-- Scripts -->
      <script src="../assets/js/main.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

      <script>
        const MSG_MARK = "##MSG##";
        const TAG_MARK = "##TAGS##";

        var storage = modules.helper.getStrage();
        const keys = {
          settings: "settings",
          tag_list: "tag_list",
        };

        (function($) {
          function init(){
            initLayout();

            loadSetting();

            $('#make-btn').on('click', function(){
              var messages = [];

              var templateMessage = $('#template-msg').val();
              messages.push(replacer(templateMessage));

              $('textarea[name="make-msg"]').val(messages.join("\n"));

              saveSettings();
            });

            $('#option-open-btn').on('click', function(){
            	$('#option-area').css('display', 'block');

            	$('#option-open-btn').css('display', 'none');
            	$('#option-close-btn').css('display', 'block');
            });
            $('#option-close-btn').on('click', function(){
            	$('#option-area').css('display', 'none');

            	$('#option-open-btn').css('display', 'block');
            	$('#option-close-btn').css('display', 'none');
            });

            $('#make-msg').on('focus', function(){
            	if(execCopy($(this).val())){
            		toastr.success('メッセージをコピーしました。')
            	}else{
            		toastr.error('メッセージをコピーできませんでした。')
            	}

            	/**
            	 * コピーする
            	 * https://qiita.com/simiraaaa/items/2e7478d72f365aa48356
            	 */
							function execCopy(string){
							  var temp = document.createElement('div');

							  temp.appendChild(document.createElement('pre')).textContent = string;

							  var s = temp.style;
							  s.position = 'fixed';
							  s.left = '-100%';

							  document.body.appendChild(temp);
							  document.getSelection().selectAllChildren(temp);

							  var result = document.execCommand('copy');

							  document.body.removeChild(temp);
							  // true なら実行できている falseなら失敗か対応していないか
							  return result;
							}
            });

          }

          /**
           * レイアウトの初期処理
           */
          function initLayout(){
            var text = $('#header h1 a').text();
            $('#header h1 a').html(modules.helper.eachTopCharUpper(text, '<span style="color: #21b2a6">', '</span>'));
          };

          /**
           * ストレージの状態を画面に反映
           */
          function loadSetting(){
            if(!storage.getItem(keys.settings)){
              setDefaultSettings();
              toastr.info('基本値に初期値を設定しました。');
            }else{
              const settings = JSON.parse(storage.getItem(keys.settings));

              $('#template-msg').val(settings['template']);
              $('#new-line').val(settings['new_line']);
              $('#tags').val(settings['tags']);
              $('#tag-list').val(settings['tag_list']);
              $('#select-tag-num').val(settings['select_tag_num']);
              $('#tag-per-line').prop("checked", settings['tag_per_line']);
              $('#random-order').prop("checked", settings['random_order']);
            }

            if(!storage.getItem(keys.tag_list)){
              setDefaultTagList();
              toastr.info('タグリストに初期値を設定しました。');
            }else{
              const tagList = JSON.parse(storage.getItem(keys.tag_list));
              createSelectBox({
                  one: tagList['tag1_name'],
                  two: tagList['tag2_name'],
                  three: tagList['tag3_name'],
                  four: tagList['tag4_name'],
                },
                'tag-list',
                'one');

              if(storage.getItem(keys.settings)){
                const settings = JSON.parse(storage.getItem(keys.settings));
                $('#tag-list').val(settings['tag_list']);
              }
            }
          }

          /**
           * デフォルト値を設定
           */
          function setDefaultSettings(){
            $('#template-msg').val("##MSG##\n\n##TAGS##");
            $('#new-line').val('・');
            $('#tags').val('#sample #sample1 #sample2');
          }

          /**
           * デフォルト値を設定
           */
          function setDefaultTagList(){
            createSelectBox({
                one: 'タグ1',
                two: 'タグ2',
                three: 'タグ3',
                four: 'タグ4',
              },
              'tag-list',
              'one');
          }

          /**
           * デフォルト値を設定
           */
          function createSelectBox(characters, targetId, targetVal){
            var $select = $('#' + targetId),
                $option,
                isSelected;

            $.each(characters, function (value, name) {
                isSelected = (value === targetVal);
                $option = $('<option>')
                    .val(value)
                    .text(name)
                    .prop('selected', isSelected);
                $select.append($option);
            });
          }

          /**
           * 設定をストレージに保存する
           */
          function saveSettings(){
            var settings = {
              template: $('#template-msg').val(),
              new_line: $('#new-line').val(),
              tags: modules.helper.formatTag($('#tags').val().substring(1, $('#tags').val().length)),
              tag_list: $('#tag-list').val(),
              select_tag_num: $('#select-tag-num').val(),
              tag_per_line: $('#tag-per-line').prop('checked'),
              random_order: $('#random-order').prop('checked'),
            }

            // 設定の保持
            storage.setItem(keys.settings, JSON.stringify(settings));
          }

          /**
           * 記号の置換を行う
           */
          function replacer(str){
            str = replaceMessage(str);

            if(hasTags(str)){
              str = replaceTags(str);
            }

            str = replaceNewLine(str);

            return str;
          }

          /**
           * メッセージを置換する
           */
          function replaceMessage(str){
            var message = $('#msg').val();
            return str.replace(new RegExp(MSG_MARK), message);
          }

          /**
           * 改行を指定の文字列に変換
           */
          function replaceNewLine(str){
            var newLine = $('#new-line').val();
            var lines = str.split(/\r?\n/g);
            lines.forEach(function(val, i, ar){
              if(val.length == 0){
                ar[i] = newLine;
              }
            });

            return lines.join('\n');
          }

          /**
           * タグを持っているか？
           */
          function hasTags(str){
            return str.match(new RegExp(TAG_MARK));
          }

          /**
           * タグコードをタグに変換
           */
          function replaceTags(str){
            var rawTagsStr = $('#tags').val();
            rawTagsStr = modules.helper.formatTag(rawTagsStr);
            var tags = null;
            if(storage.getItem(keys.tag_list)){
              const tagList = JSON.parse(storage.getItem(keys.tag_list));
              var selectTag = $('#tag-list').val();
              if(selectTag == 'one'){
                tags = tagList['tags1'];
              }else if(selectTag == 'two'){
                tags = tagList['tags2'];
              }else if(selectTag == 'three'){
                tags = tagList['tags3'];
              }else if(selectTag == 'four'){
                tags = tagList['tags4'];
              }
            }
            tags = rawTagsStr.substring(1, rawTagsStr.length).split('#');

            // タグからランダムに取得する
            if($('#select-tag-num').val() != ""){
              function randomAry(array, num) {
                var a = array;
                var t = [];
                var r = [];
                var l = a.length;
                var n = num < l ? num : l;
                while (n-- > 0) {
                  var i = Math.random() * l | 0;
                  r[n] = t[i] || a[i];
                  --l;
                  t[i] = t[l] || a[l];
                }
                return r;
              }

              var selectTagNum = $('#select-tag-num').val();
              // 指定されたタグ数が多すぎ
              if(selectTagNum > tags.length){
                selectTagNum = tags.length;
              }
              // 指定されたタグ数がマイナス
              if(tags.length < 0){
                selectTagNum = tags.length;
              }

              tags = randomAry(tags, selectTagNum);
            }

            // ランダムに配置する
            if($('#random-order').prop('checked')){
              function shuffleAry(ary) {
                var i = ary.length;
                while(i){
                  var j = Math.floor(Math.random()*i);
                  var t = ary[--i];
                  ary[i] = ary[j];
                  ary[j] = t;
                }
                return ary;
              }

              tags = shuffleAry(tags);
            }

            var tagsStr = null;
            // タグを一行毎に出力する
            if($('#tag-per-line').prop('checked')){
              tagsStr = '#' + tags.join('\n#');
            }else{
              tagsStr = '#' + tags.join(' #'); // #tag #tag...
            }

            return str.replace(new RegExp(TAG_MARK), tagsStr);
          }

          init();
        })(jQuery);
      </script>
  </body>
</html>